
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Fidelexa</title>
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 50px auto; padding: 20px; }
    input, button { width: 100%; padding: 10px; margin-top: 10px; }
    img { margin-top: 20px; width: 100%; max-width: 256px; }
    #resultado { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Regístrate y recibe tu QR</h2>
  <input type="text" id="name" placeholder="Tu nombre" required />
  <input type="email" id="email" placeholder="Tu email" required />
  <button onclick="register()">Registrarse</button>

  <div id="resultado"></div>

  <script>
    async function register() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const negocio = new URLSearchParams(window.location.search).get("negocio");
      const resultado = document.getElementById('resultado');

      if (!name || !email || !negocio) {
        resultado.innerHTML = '<p style="color:red;">Faltan datos: asegúrate de usar un enlace con ?negocio=</p>';
        return;
      }

      resultado.innerHTML = 'Registrando...';

      try {
        const response = await fetch("https://oqskgarzuztkagvupqsk.supabase.co/functions/v1/register_customer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xc2tnYXJ6dXp0a2FndnVwcXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NjA3NzYsImV4cCI6MjA2NTIzNjc3Nn0.GttqwBmOrD09QDY68QFUN1_zrUQBCa7R4iBNC2qZZ0o"
          },
          body: JSON.stringify({ name, email, negocio })
        });

        const data = await response.json();

        if (response.ok) {
          resultado.innerHTML = `
            <p>¡Registro exitoso! Aquí tienes tu código QR:</p>
            <img src="${data.qr_url}" alt="QR" />
          `;
        } else {
          resultado.innerHTML = `<p style="color:red;">Error: ${data.error || JSON.stringify(data)}</p>`;
        }
      } catch (err) {
        resultado.innerHTML = `<p style="color:red;">Error de conexión: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
