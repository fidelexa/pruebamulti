
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro - Multi Negocio</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      background-color: #f2f2f2;
      text-align: center;
    }
    img#logo {
      max-width: 120px;
      margin-bottom: 20px;
    }
    h2 {
      margin-bottom: 10px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: none;
      border-radius: 6px;
    }
    button {
      background-color: #333;
      color: white;
      cursor: pointer;
    }
    #resultado {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <img id="logo" src="" alt="Logo negocio" />
  <h2>Registro</h2>

  <input type="text" id="name" placeholder="Tu nombre" required />
  <input type="email" id="email" placeholder="Tu email" required />
  <button onclick="register()">Registrarse</button>

  <div id="resultado"></div>

  <script>
    const slug = new URLSearchParams(window.location.search).get("negocio");

    const supabase = window.supabase.createClient(
      "https://oqskgarzuztkagvupqsk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xc2tnYXJ6dXp0a2FndnVwcXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NjA3NzYsImV4cCI6MjA2NTIzNjc3Nn0.GttqwBmOrD09QDY68QFUN1_zrUQBCa7R4iBNC2qZZ0o"
    );

    async function cargarLogo(slug) {
      const { data, error } = await supabase
        .from("businesses")
        .select("logo_url")
        .eq("slug", slug)
        .single();

      if (data?.logo_url) {
        document.getElementById("logo").src = data.logo_url;
      } else {
        console.error("No se encontró logo para el slug:", slug, error);
      }
    }

    if (slug) {
      cargarLogo(slug);
    } else {
      console.error("Slug no detectado en la URL");
    }

    async function register() {
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const resultado = document.getElementById("resultado");

      if (!name || !email || !slug) {
        resultado.innerHTML = '<p style="color:red;">Faltan datos o negocio inválido</p>';
        return;
      }

      resultado.innerHTML = "Registrando...";

      try {
        const response = await fetch("https://oqskgarzuztkagvupqsk.supabase.co/functions/v1/register_customer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9xc2tnYXJ6dXp0a2FndnVwcXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NjA3NzYsImV4cCI6MjA2NTIzNjc3Nn0.GttqwBmOrD09QDY68QFUN1_zrUQBCa7R4iBNC2qZZ0o"
          },
          body: JSON.stringify({ name, email, negocio: slug })
        });

        const data = await response.json();

        if (response.ok) {
          resultado.innerHTML = `
            <p>¡Registro exitoso!</p>
            <img src="${data.qr_url}" alt="QR" style="margin-top: 10px; width: 200px;" />
          `;
        } else {
          resultado.innerHTML = `<p style="color:red;">Error: ${data.error || JSON.stringify(data)}</p>`;
        }
      } catch (err) {
        resultado.innerHTML = `<p style="color:red;">Error de conexión: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
